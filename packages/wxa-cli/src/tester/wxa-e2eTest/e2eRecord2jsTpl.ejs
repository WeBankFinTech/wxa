/* eslint-disable no-console */
/* eslint-disable no-undef */
import automator from 'miniprogram-automator';
import path from 'path';

const sleep = t => new Promise(resolve => setTimeout(resolve, t));
describe('==== <%= name %> ====', () => {
    let miniProgram;
    let page;

    beforeAll(async () => {
        jest.setTimeout(300000);
        miniProgram = await automator.launch({
            cliPath: '<%= cliPath %>',
            projectPath: path.resolve(process.cwd(), './dist/')
        });

        page = await miniProgram.currentPage();
    }, 300000);

    afterAll(async () => {
        // await miniProgram.close();
    });

    test('<%= name %>', async () => {
        let page = await miniProgram.reLaunch("/<%= record[0].page%>");
        let element;
        await page.waitFor(300);

        <% record.forEach(function(item){ %>
            while (true) {
                page = await miniProgram.currentPage()
                if (page.path === '<%= item.page %>') {
                    break;
                }
                await sleep(1000);
            }

            await page.waitFor('.<%= item.id %>');
            element = await page.$('.<%= item.id %>')
            <% if (!!~['tap', 'longpress'].indexOf(item.event)) { %>
            await element.<%= item.event%>();
            <% } else if (!!~['input'].indexOf(item.event)) { %>
                await element.<%= item.event%>("<%= item.detail.value %>");
            <% } else if (!!~['touchstart', 'touchmove', 'touchend'].indexOf(item.event)) { %>
                await element.<%= item.event%>({
                    touches: <%-JSON.stringify(item.touches)%>,
                    changedTouches: <%-JSON.stringify(item.changedTouches)%>
                });
            <% } else { %>
            await element.trigger('<%=item.event%>', <%-JSON.stringify(item.detail)%>);
            <% } %>
            await page.waitFor(300)
        <% }); %>
    });
});
